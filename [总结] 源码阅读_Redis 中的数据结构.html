
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <!-- common.css -->
      <style>* {-webkit-tap-highlight-color: rgba(0,0,0,0);}html {-webkit-text-size-adjust: none;}body {font-family: -apple-system, Helvetica, Arial, sans-serif;margin: 0;padding: 20px;color: #333;word-wrap: break-word;}h1, h2, h3, h4, h5, h6 {line-height: 1.1;}img {max-width: 100% !important;height: auto;}blockquote {margin: 0;padding: 0 15px;color: #777;border-left: 4px solid #ddd;}hr {background-color: #ddd;border: 0;height: 1px;margin: 15px 0;}code {font-family: Menlo, Consolas, 'Ubuntu Mono', Monaco, 'source-code-pro', monospace;line-height: 1.4;margin: 0;padding: 0.2em 0;font-size: 90%;background-color: rgba(0,0,0,0.04);border-radius: 3px;}pre > code {margin: 0;padding: 0;font-size: 100%;word-break: normal;background: transparent;border: 0;}ol {list-style-type: decimal;}ol ol, ul ol {list-style-type: lower-latin;}ol ol ol, ul ol ol, ul ul ol, ol ul ol {list-style-type: lower-roman;}table {border-spacing: 0;border-collapse: collapse;margin-top: 0;margin-bottom: 16px;}table th {font-weight: bold;}table th, table td {padding: 6px 13px;border: 1px solid #ddd;}table tr {border-top: 1px solid #ccc;}table tr:nth-child(even) {background-color: #f8f8f8;}input[type="checkbox"] {cursor: default;margin-right: 0.5em;font-size: 13px;}.task-list-item {list-style-type: none;}.task-list-item+.task-list-item {margin-top: 3px;}.task-list-item input {float: left;margin: 0.3em 1em 0.25em -1.6em;vertical-align: middle;}#tag-field {margin: 8px 2px 10px;}#tag-field .tag {display: inline-block;background: #cadff3;border-radius: 4px;padding: 1px 8px;color: black;font-size: 12px;margin-right: 10px;line-height: 1.4;}</style>
      <!-- ace-static.css -->
      <style>.ace_static_highlight {white-space: pre-wrap;}.ace_static_highlight .ace_gutter {width: 2em;text-align: right;padding: 0 3px 0 0;margin-right: 3px;}.ace_static_highlight.ace_show_gutter > .ace_line {padding-left: 2.6em;}.ace_static_highlight .ace_line {position: relative;}.ace_static_highlight .ace_gutter-cell {-moz-user-select: -moz-none;-khtml-user-select: none;-webkit-user-select: none;user-select: none;top: 0;bottom: 0;left: 0;position: absolute;}.ace_static_highlight .ace_gutter-cell:before {content: counter(ace_line, decimal);counter-increment: ace_line;}.ace_static_highlight {counter-reset: ace_line;}</style>
      <style>.ace-chrome .ace_gutter {background: #ebebeb;color: #333;overflow : hidden;}.ace-chrome .ace_print-margin {width: 1px;background: #e8e8e8;}.ace-chrome {background-color: #FFFFFF;color: black;}.ace-chrome .ace_cursor {color: black;}.ace-chrome .ace_invisible {color: rgb(191, 191, 191);}.ace-chrome .ace_constant.ace_buildin {color: rgb(88, 72, 246);}.ace-chrome .ace_constant.ace_language {color: rgb(88, 92, 246);}.ace-chrome .ace_constant.ace_library {color: rgb(6, 150, 14);}.ace-chrome .ace_invalid {background-color: rgb(153, 0, 0);color: white;}.ace-chrome .ace_fold {}.ace-chrome .ace_support.ace_function {color: rgb(60, 76, 114);}.ace-chrome .ace_support.ace_constant {color: rgb(6, 150, 14);}.ace-chrome .ace_support.ace_type,.ace-chrome .ace_support.ace_class.ace-chrome .ace_support.ace_other {color: rgb(109, 121, 222);}.ace-chrome .ace_variable.ace_parameter {font-style:italic;color:#FD971F;}.ace-chrome .ace_keyword.ace_operator {color: rgb(104, 118, 135);}.ace-chrome .ace_comment {color: #236e24;}.ace-chrome .ace_comment.ace_doc {color: #236e24;}.ace-chrome .ace_comment.ace_doc.ace_tag {color: #236e24;}.ace-chrome .ace_constant.ace_numeric {color: rgb(0, 0, 205);}.ace-chrome .ace_variable {color: rgb(49, 132, 149);}.ace-chrome .ace_xml-pe {color: rgb(104, 104, 91);}.ace-chrome .ace_entity.ace_name.ace_function {color: #0000A2;}.ace-chrome .ace_heading {color: rgb(12, 7, 255);}.ace-chrome .ace_list {color:rgb(185, 6, 144);}.ace-chrome .ace_marker-layer .ace_selection {background: rgb(181, 213, 255);}.ace-chrome .ace_marker-layer .ace_step {background: rgb(252, 255, 0);}.ace-chrome .ace_marker-layer .ace_stack {background: rgb(164, 229, 101);}.ace-chrome .ace_marker-layer .ace_bracket {margin: -1px 0 0 -1px;border: 1px solid rgb(192, 192, 192);}.ace-chrome .ace_marker-layer .ace_active-line {background: rgba(0, 0, 0, 0.07);}.ace-chrome .ace_gutter-active-line {background-color : #dcdcdc;}.ace-chrome .ace_marker-layer .ace_selected-word {background: rgb(250, 250, 255);border: 1px solid rgb(200, 200, 250);}.ace-chrome .ace_storage,.ace-chrome .ace_keyword,.ace-chrome .ace_meta.ace_tag {color: rgb(147, 15, 128);}.ace-chrome .ace_string.ace_regex {color: rgb(255, 0, 0)}.ace-chrome .ace_string {color: #1A1AA6;}.ace-chrome .ace_entity.ace_other.ace_attribute-name {color: #994409;}.ace-chrome .ace_indent-guide {background: url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAACCAYAAACZgbYnAAAAE0lEQVQImWP4////f4bLly//BwAmVgd1/w11/gAAAABJRU5ErkJggg==") right repeat-y;}</style>
      <!-- export.css -->
      <style>
        body{margin:0 auto;max-width:800px;line-height:1.4}
        #nav{margin:5px 0 10px;font-size:15px}
        #titlearea{border-bottom:1px solid #ccc;font-size:17px;padding:10px 0;}
        #contentarea{font-size:15px;margin:16px 0}
        .cell{outline:0;min-height:20px;margin:5px 0;padding:5px 0;}
        .code-cell{font-family:Menlo,Consolas,'Ubuntu Mono',Monaco,'source-code-pro',monospace;font-size:12px;}
        .latex-cell{white-space:pre-wrap;}
      </style>
      <!-- User CSS -->
      <style> .text-cell {font-size: 15px;}.code-cell {font-size: 12px;}.markdown-cell {font-size: 15px;}.latex-cell {font-size: 15px;}</style>
    </head>
    <body>
      <div id="nav"><div>Next: <a href='[总结] 培训讲义_密码学基础.html'>[总结] 培训讲义_密码学基础</a>, Previous: <a href='[笔记] Micro Frontends In Action.html'>[笔记] Micro Frontends In Action</a>, Up: <a href='index.html'>Index</a></div></div>
      <div id="titlearea">
        <h2>[总结] 源码阅读_Redis 中的数据结构</h2>
      </div>
      <div id="contentarea"><div class="cell markdown-cell"><h1>简单动态字符串（SDS）</h1>
<p>Redis 底层使用 <strong>SDS</strong> (Simple Dynamic Strings) 作为字符串类型的存储方式之一，其结构非常简单，直接看源码即可了解个大概：</p>
<pre><div class="ace-chrome"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_type">typedef</span> <span class="ace_storage ace_type">char</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">sds</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_type">struct</span> <span class="ace_identifier">sdshdr</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_storage ace_type">unsigned</span> <span class="ace_storage ace_type">int</span> <span class="ace_identifier">len</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_storage ace_type">unsigned</span> <span class="ace_storage ace_type">int</span> <span class="ace_support ace_function ace_C99 ace_c">free</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_storage ace_type">char</span> <span class="ace_identifier">buf</span><span class="ace_paren ace_lparen">[</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span><span class="ace_punctuation ace_operator">;</span>
</div></div></div></pre>
<p>其中，结构体 sdshdr 中的 len 用来存储字符串的实际长度，free 用来存储预留空间的长度，buf 用来存储字符串内容。</p>
<p>与一般动态字符串直接使用结构体表示字符串的实现方式不同，sds 仍使用 <code>char*</code> 表示字符串，只是其指向的位置略微特殊而已。通过创建 sds 的函数，可以看出这种特殊性：</p>
<pre><div class="ace-chrome"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">sds</span> <span class="ace_identifier">sdsnewlen</span><span class="ace_paren ace_lparen">(</span><span class="ace_storage ace_modifier">const</span> <span class="ace_storage ace_type">void</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">init</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_identifier">size_t</span> <span class="ace_identifier">initlen</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_storage ace_type">struct</span> <span class="ace_identifier">sdshdr</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">sh</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">init</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">sh</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">zmalloc</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">sizeof</span><span class="ace_paren ace_lparen">(</span><span class="ace_storage ace_type">struct</span> <span class="ace_identifier">sdshdr</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">+</span><span class="ace_identifier">initlen</span><span class="ace_constant ace_numeric">+1</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span> <span class="ace_keyword ace_control">else</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">sh</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">zcalloc</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">sizeof</span><span class="ace_paren ace_lparen">(</span><span class="ace_storage ace_type">struct</span> <span class="ace_identifier">sdshdr</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">+</span><span class="ace_identifier">initlen</span><span class="ace_constant ace_numeric">+1</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">sh</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_constant ace_language">NULL</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_control">return</span> <span class="ace_constant ace_language">NULL</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">sh</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">len</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">initlen</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">sh</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_support ace_function ace_C99 ace_c">free</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">initlen</span> <span class="ace_keyword ace_operator">&amp;&amp;</span> <span class="ace_identifier">init</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_support ace_function ace_C99 ace_c">memcpy</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">sh</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">buf</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_identifier">init</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_identifier">initlen</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">sh</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">buf</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">initlen</span><span class="ace_paren ace_rparen">]</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_string">'\0'</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">return</span> <span class="ace_paren ace_lparen">(</span><span class="ace_storage ace_type">char</span><span class="ace_keyword ace_operator">*</span><span class="ace_paren ace_rparen">)</span><span class="ace_identifier">sh</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">buf</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div></div></div></pre>
<p>通过源代码了解到，实际存储字符串相关信息的仍然是 <code>struct</code> （sdshdr），sds 其实是返回指向其 buf 数组的首个元素的指针。借用 redis 作者的描述：</p>
<pre><code>+--------+-------------------------------+-----------+
| Header | Binary safe C alike string... | Null term |
+--------+-------------------------------+-----------+
         |
         `-&gt; Pointer returned to the user.
</code></pre>
<p>另外值得注意的是，通过：</p>
<pre><div class="ace-chrome"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">sh</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">len</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">initlen</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">sh</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_support ace_function ace_C99 ace_c">free</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span>
</div></div></div></pre>
<p>可以看出，redis 在首次创建字符串时并不会额外分配 <code>free</code> 空间，而是按字符串实际的大小申请内存空间来创建，这和 Java 中 StringBuffer 等预先分配一定容量(通常16char)的策略是不同的。</p>
<p><strong>sds 是二进制安全的</strong>，字符串中间可以包含 <code>\0</code> 。获取 sds 的长度时通常不能直接使用 strlen 而是使用 sdslen 读取其 len 值：</p>
<pre><div class="ace-chrome"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_modifier">static</span> <span class="ace_storage ace_modifier">inline</span> <span class="ace_identifier">size_t</span> <span class="ace_identifier">sdslen</span><span class="ace_paren ace_lparen">(</span><span class="ace_storage ace_modifier">const</span> <span class="ace_identifier">sds</span> <span class="ace_identifier">s</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_storage ace_type">struct</span> <span class="ace_identifier">sdshdr</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">sh</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_paren ace_lparen">(</span><span class="ace_storage ace_type">void</span><span class="ace_keyword ace_operator">*</span><span class="ace_paren ace_rparen">)</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">s</span><span class="ace_keyword ace_operator">-</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">sizeof</span><span class="ace_paren ace_lparen">(</span><span class="ace_storage ace_type">struct</span> <span class="ace_identifier">sdshdr</span><span class="ace_paren ace_rparen">)))</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">return</span> <span class="ace_identifier">sh</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">len</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div></div></div></pre>
<p>唐老师给我画了一张图，可以帮助理解：</p>
<p><img src="resources/23292DAFFAC4ED2DBA5871B52F48DDD1.png" alt="sds.png" width="474" height="156"></p>
<p>最后一个值得关注的问题是，sds 是如何扩容的？这一过程在 sdsMakeRoomFor 函数中实现：</p>
<pre><div class="ace-chrome"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">sds</span> <span class="ace_identifier">sdsMakeRoomFor</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">sds</span> <span class="ace_identifier">s</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_identifier">size_t</span> <span class="ace_identifier">addlen</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_storage ace_type">struct</span> <span class="ace_identifier">sdshdr</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">sh</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">newsh</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">size_t</span> <span class="ace_support ace_function ace_C99 ace_c">free</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">sdsavail</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">s</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">size_t</span> <span class="ace_identifier">len</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_identifier">newlen</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_support ace_function ace_C99 ace_c">free</span> <span class="ace_keyword ace_operator">&gt;=</span> <span class="ace_identifier">addlen</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_control">return</span> <span class="ace_identifier">s</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">len</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">sdslen</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">s</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">sh</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_paren ace_lparen">(</span><span class="ace_storage ace_type">void</span><span class="ace_keyword ace_operator">*</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">s</span><span class="ace_keyword ace_operator">-</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">sizeof</span><span class="ace_paren ace_lparen">(</span><span class="ace_storage ace_type">struct</span> <span class="ace_identifier">sdshdr</span><span class="ace_paren ace_rparen">)))</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">newlen</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">len</span><span class="ace_keyword ace_operator">+</span><span class="ace_identifier">addlen</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">newlen</span> <span class="ace_keyword ace_operator">&lt;</span> <span class="ace_identifier">SDS_MAX_PREALLOC</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">newlen</span> <span class="ace_keyword ace_operator">*=</span> <span class="ace_constant ace_numeric">2</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">else</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">newlen</span> <span class="ace_keyword ace_operator">+=</span> <span class="ace_identifier">SDS_MAX_PREALLOC</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">newsh</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">zrealloc</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">sh</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_keyword ace_operator">sizeof</span><span class="ace_paren ace_lparen">(</span><span class="ace_storage ace_type">struct</span> <span class="ace_identifier">sdshdr</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">+</span><span class="ace_identifier">newlen</span><span class="ace_constant ace_numeric">+1</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">newsh</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_constant ace_language">NULL</span><span class="ace_paren ace_rparen">)</span> <span class="ace_keyword ace_control">return</span> <span class="ace_constant ace_language">NULL</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">newsh</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_support ace_function ace_C99 ace_c">free</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">newlen</span> <span class="ace_keyword ace_operator">-</span> <span class="ace_identifier">len</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">return</span> <span class="ace_identifier">newsh</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">buf</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div></div></div></pre>
<p>可以看到，当扩展后的长度比 <code>SDS_MAX_PREALLOC</code> 小时，预留一倍的容量；否则增加 <code>SDS_MAX_PREALLOC</code> 的容量。当前版本中：</p>
<pre><div class="ace-chrome"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> SDS_MAX_PREALLOC (1024*1024)</span>
</div></div></div></pre>
<p>理解了这些便很容易知道 redis <code>APPEND</code> 命令的实现细节：</p>
<pre><div class="ace-chrome"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>$ <span class="ace_identifier">SET</span> <span class="ace_identifier">foo</span> <span class="ace_identifier">bar</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>$ <span class="ace_identifier">APPEND</span> <span class="ace_identifier">foo</span> <span class="ace_identifier">blahblah</span>
</div></div></div></pre>
<p>当然，这种预先分配容量的方式，虽然能减少内存分配的次数，提高 <code>APPEND</code> 操作的性能，但会造成一定的内存占用，而且此部分内存不会主动释放。</p>
<h1>双链表</h1>
<p>Redis 实现了通用的双链表作为其基础数据结构之一。双链表是 redis 列表类型的实际存储方式之一，同时双链表还被其它功能模块广泛使用。它由三部分组成：</p>
<ul>
<li>节点</li>
<li>迭代器</li>
<li>链表自身</li>
</ul>
<p>其<strong>节点</strong>如下：</p>
<pre><div class="ace-chrome"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_type">typedef</span> <span class="ace_storage ace_type">struct</span> <span class="ace_identifier">listNode</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_storage ace_type">struct</span> <span class="ace_identifier">listNode</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">prev</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_storage ace_type">struct</span> <span class="ace_identifier">listNode</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">next</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_storage ace_type">void</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">value</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span> <span class="ace_identifier">listNode</span><span class="ace_punctuation ace_operator">;</span>
</div></div></div></pre>
<p>包含指向前驱、后继节点的指针及当前节点存储的值。这个值的类型为 <code>void*</code> ，说明 redis 并不限制链表存储的数据类型。</p>
<p><strong>链表</strong>的定义如下：</p>
<pre><div class="ace-chrome"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_type">typedef</span> <span class="ace_storage ace_type">struct</span> <span class="ace_identifier">list</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">listNode</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">head</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">listNode</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">tail</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_storage ace_type">void</span> <span class="ace_keyword ace_operator">*</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">*</span><span class="ace_identifier">dup</span><span class="ace_paren ace_rparen">)</span><span class="ace_paren ace_lparen">(</span><span class="ace_storage ace_type">void</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">ptr</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_storage ace_type">void</span> <span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">*</span><span class="ace_support ace_function ace_C99 ace_c">free</span><span class="ace_paren ace_rparen">)</span><span class="ace_paren ace_lparen">(</span><span class="ace_storage ace_type">void</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">ptr</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_storage ace_type">int</span> <span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">*</span><span class="ace_identifier">match</span><span class="ace_paren ace_rparen">)</span><span class="ace_paren ace_lparen">(</span><span class="ace_storage ace_type">void</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">ptr</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_storage ace_type">void</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">key</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_storage ace_type">unsigned</span> <span class="ace_storage ace_type">long</span> <span class="ace_identifier">len</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span> <span class="ace_identifier">list</span><span class="ace_punctuation ace_operator">;</span>
</div></div></div></pre>
<p><code>list</code> 中保存了指向表头和表尾的指针，因此在执行 <code>LPUSH</code>、<code>RPUSH</code>、<code>RPOP</code> 等命令时是非常快的(θ(1))；其中还保存了 len 值，因此 <code>LLEN</code> 命令的执行也是非常快的。</p>
<p><img src="resources/60E77FCC62AFB881BD511EFBA5CC2D75.jpg" alt="double_link_list" width="722" height="284"></p>
<p>另外，它还保存了三个函数指针 dup、free 和 match 用来复制、释放和对比链表，这样做是因为节点值的类型是不确定的，具体的实现方法交由用户代码灵活扩展处理。比如如果用户定义了 match 函数的实现，则采用它来替换默认使用 <code>==</code> 的比较策略：</p>
<pre><div class="ace-chrome"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">list</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">match</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">list</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">match</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">node</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">value</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_identifier">key</span><span class="ace_paren ace_rparen">))</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">listReleaseIterator</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">iter</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">return</span> <span class="ace_identifier">node</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span> <span class="ace_keyword ace_control">else</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">key</span> <span class="ace_keyword ace_operator">==</span> <span class="ace_identifier">node</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">value</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">listReleaseIterator</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">iter</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">return</span> <span class="ace_identifier">node</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div></div></div></pre>
<p>类似地，释放一个链表时会优先调用指定的 free 函数后再完成其它释放过程：</p>
<pre><div class="ace-chrome"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_type">void</span> <span class="ace_identifier">listRelease</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">list</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">list</span><span class="ace_paren ace_rparen">)</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_storage ace_type">unsigned</span> <span class="ace_storage ace_type">long</span> <span class="ace_identifier">len</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">listNode</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">current</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">next</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">current</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">list</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">head</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">len</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">list</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">len</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_keyword ace_control">while</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">len</span><span class="ace_keyword ace_operator">--</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">next</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">current</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">next</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_keyword ace_control">if</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">list</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_support ace_function ace_C99 ace_c">free</span><span class="ace_paren ace_rparen">)</span> <span class="ace_identifier">list</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_support ace_function ace_C99 ace_c">free</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">current</span><span class="ace_keyword ace_operator">-&gt;</span><span class="ace_identifier">value</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">zfree</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">current</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">current</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">next</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">zfree</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">list</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div></div></div></pre>
<p><strong>迭代器</strong>的结构如下：</p>
<pre><div class="ace-chrome"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_type">typedef</span> <span class="ace_storage ace_type">struct</span> <span class="ace_identifier">listIter</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">listNode</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">next</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_storage ace_type">int</span> <span class="ace_identifier">direction</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span> <span class="ace_identifier">listIter</span><span class="ace_punctuation ace_operator">;</span>
</div></div></div></pre>
<p>其中，direction 可以向前或向后：</p>
<pre><div class="ace-chrome"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> AL_START_HEAD 0</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> AL_START_TAIL 1</span>
</div></div></div></pre>
<p>可以通过：</p>
<pre><div class="ace-chrome"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">listIter</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">listGetIterator</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">list</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">list</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_storage ace_type">int</span> <span class="ace_identifier">direction</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div></div></div></pre>
<p>获得迭代器，通过：</p>
<pre><div class="ace-chrome"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">listNode</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">listNext</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">listIter</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">iter</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div></div></div></pre>
<p>进行遍历。另外，还可以将指针移到表头或表尾：</p>
<pre><div class="ace-chrome"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_type">void</span> <span class="ace_identifier">listRewind</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">list</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">list</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_identifier">listIter</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">li</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_type">void</span> <span class="ace_identifier">listRewindTail</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">list</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">list</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_identifier">listIter</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">li</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div></div></div></pre>
<h1>散列表</h1>
<p>散列表是 redis 中的基础数据结构之一， redis 中的键空间、redisDB、 <code>SET</code>、<code>ZSET</code>、集群节点映射等，都是通过散列表实现的。结构体定义为：</p>
<pre><div class="ace-chrome"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_type">typedef</span> <span class="ace_storage ace_type">struct</span> <span class="ace_identifier">dict</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">dictType</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">type</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_storage ace_type">void</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">privdata</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">dictht</span> <span class="ace_identifier">ht</span><span class="ace_paren ace_lparen">[</span><span class="ace_constant ace_numeric">2</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_storage ace_type">long</span> <span class="ace_identifier">rehashidx</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_storage ace_type">int</span> <span class="ace_identifier">iterators</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span> <span class="ace_identifier">dict</span><span class="ace_punctuation ace_operator">;</span>
</div></div></div></pre>
<p>其中，<code>*type</code> 指针指向 dict 的类型，例如它是一个 ZSET(zsetDictType) 还是一个集群节点(clusterNodesDictType)。实际上它们的存储结构是相同的，之所以区分类型，是因为其散列函数、key 的比较(或销毁)策略是不同的。因而所谓的 dict 类型，不过是一组函数指针罢了：</p>
<pre><div class="ace-chrome"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_type">typedef</span> <span class="ace_storage ace_type">struct</span> <span class="ace_identifier">dictType</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_storage ace_type">unsigned</span> <span class="ace_storage ace_type">int</span> <span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">*</span><span class="ace_identifier">hashFunction</span><span class="ace_paren ace_rparen">)</span><span class="ace_paren ace_lparen">(</span><span class="ace_storage ace_modifier">const</span> <span class="ace_storage ace_type">void</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">key</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>       <span class="ace_comment">// <span class="ace_cjk" style="width:NaNpx">散</span><span class="ace_cjk" style="width:NaNpx">列</span><span class="ace_cjk" style="width:NaNpx">函</span><span class="ace_cjk" style="width:NaNpx">数</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_storage ace_type">void</span> <span class="ace_keyword ace_operator">*</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">*</span><span class="ace_identifier">keyDup</span><span class="ace_paren ace_rparen">)</span><span class="ace_paren ace_lparen">(</span><span class="ace_storage ace_type">void</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">privdata</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_storage ace_modifier">const</span> <span class="ace_storage ace_type">void</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">key</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>    <span class="ace_comment">// key <span class="ace_cjk" style="width:NaNpx">复</span><span class="ace_cjk" style="width:NaNpx">制</span><span class="ace_cjk" style="width:NaNpx">函</span><span class="ace_cjk" style="width:NaNpx">数</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_storage ace_type">void</span> <span class="ace_keyword ace_operator">*</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">*</span><span class="ace_identifier">valDup</span><span class="ace_paren ace_rparen">)</span><span class="ace_paren ace_lparen">(</span><span class="ace_storage ace_type">void</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">privdata</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_storage ace_modifier">const</span> <span class="ace_storage ace_type">void</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">obj</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>    <span class="ace_comment">// value <span class="ace_cjk" style="width:NaNpx">复</span><span class="ace_cjk" style="width:NaNpx">制</span><span class="ace_cjk" style="width:NaNpx">函</span><span class="ace_cjk" style="width:NaNpx">数</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_storage ace_type">int</span> <span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">*</span><span class="ace_identifier">keyCompare</span><span class="ace_paren ace_rparen">)</span><span class="ace_paren ace_lparen">(</span><span class="ace_storage ace_type">void</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">privdata</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_storage ace_modifier">const</span> <span class="ace_storage ace_type">void</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">key1</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_storage ace_modifier">const</span> <span class="ace_storage ace_type">void</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">key2</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>     <span class="ace_comment">// key <span class="ace_cjk" style="width:NaNpx">比</span><span class="ace_cjk" style="width:NaNpx">较</span><span class="ace_cjk" style="width:NaNpx">函</span><span class="ace_cjk" style="width:NaNpx">数</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_storage ace_type">void</span> <span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">*</span><span class="ace_identifier">keyDestructor</span><span class="ace_paren ace_rparen">)</span><span class="ace_paren ace_lparen">(</span><span class="ace_storage ace_type">void</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">privdata</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_storage ace_type">void</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">key</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>    <span class="ace_comment">// key <span class="ace_cjk" style="width:NaNpx">销</span><span class="ace_cjk" style="width:NaNpx">毁</span><span class="ace_cjk" style="width:NaNpx">函</span><span class="ace_cjk" style="width:NaNpx">数</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_storage ace_type">void</span> <span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">*</span><span class="ace_identifier">valDestructor</span><span class="ace_paren ace_rparen">)</span><span class="ace_paren ace_lparen">(</span><span class="ace_storage ace_type">void</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">privdata</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_storage ace_type">void</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">obj</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>    <span class="ace_comment">// value <span class="ace_cjk" style="width:NaNpx">销</span><span class="ace_cjk" style="width:NaNpx">毁</span><span class="ace_cjk" style="width:NaNpx">函</span><span class="ace_cjk" style="width:NaNpx">数</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span> <span class="ace_identifier">dictType</span><span class="ace_punctuation ace_operator">;</span>
</div></div></div></pre>
<p>数组 <code>ht</code> 中存放的是 dict 的实际散列表结构 <code>dictht</code> ：</p>
<pre><div class="ace-chrome"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_type">typedef</span> <span class="ace_storage ace_type">struct</span> <span class="ace_identifier">dictht</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">dictEntry</span> <span class="ace_keyword ace_operator">**</span><span class="ace_identifier">table</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_storage ace_type">unsigned</span> <span class="ace_storage ace_type">long</span> <span class="ace_identifier">size</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_storage ace_type">unsigned</span> <span class="ace_storage ace_type">long</span> <span class="ace_identifier">sizemask</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_storage ace_type">unsigned</span> <span class="ace_storage ace_type">long</span> <span class="ace_identifier">used</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span> <span class="ace_identifier">dictht</span><span class="ace_punctuation ace_operator">;</span>
</div></div></div></pre>
<p>之所以存放 2 个，是为了实现<strong>渐进式再散列(incremental rehashing)</strong>。</p>
<p><code>**table</code> 指向桶结构 <code>dictEntry</code> :</p>
<pre><div class="ace-chrome"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_type">typedef</span> <span class="ace_storage ace_type">struct</span> <span class="ace_identifier">dictEntry</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_storage ace_type">void</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">key</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_storage ace_type">union</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_storage ace_type">void</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">val</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">uint64_t</span> <span class="ace_identifier">u64</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_identifier">int64_t</span> <span class="ace_identifier">s64</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_indent-guide">    </span>    <span class="ace_storage ace_type">double</span> <span class="ace_identifier">d</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_paren ace_rparen">}</span> <span class="ace_identifier">v</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_storage ace_type">struct</span> <span class="ace_identifier">dictEntry</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">next</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span> <span class="ace_identifier">dictEntry</span><span class="ace_punctuation ace_operator">;</span>
</div></div></div></pre>
<p>当发生冲突时，dict 首先会使用<strong>分离链接法</strong>将散列到同一个值的所有元素保留到一个表中。当到了一定时机，它会通过<strong>再散列</strong>进行扩展。</p>
<p><img src="resources/053A33AD926FC77065F91A1CF3572323.jpg" alt="redis-dict" width="958" height="293"></p>
<p>Redis 还提供了遍历散列表用的迭代器，它支持安全(遍历期间可以增加元素等操作)、不安全两种方式遍历散列表：</p>
<pre><div class="ace-chrome"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_type">typedef</span> <span class="ace_storage ace_type">struct</span> <span class="ace_identifier">dictIterator</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">dict</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">d</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_storage ace_type">long</span> <span class="ace_identifier">index</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_storage ace_type">int</span> <span class="ace_identifier">table</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_identifier">safe</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">dictEntry</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">entry</span><span class="ace_punctuation ace_operator">,</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">nextEntry</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_storage ace_type">long</span> <span class="ace_storage ace_type">long</span> <span class="ace_identifier">fingerprint</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span> <span class="ace_identifier">dictIterator</span><span class="ace_punctuation ace_operator">;</span>
</div></div></div></pre>
<p>todo 渐进式再散列</p>
<h1>数据存储结构关系</h1>
<p>总起来看，redis 的数据存储结构大致是这样的：</p>
<p><img src="resources/2F9A2DE767196BF0A82C7997930F2139.png" alt="overview.png" width="1740" height="972"></p>
<p>它使用全局变量 <code>server</code> 来存储服务器信息：</p>
<pre><div class="ace-chrome"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_type">struct</span> <span class="ace_identifier">redisServer</span> <span class="ace_identifier">server</span><span class="ace_punctuation ace_operator">;</span>
</div></div></div></pre>
<p>其中 <code>redisServer</code> 包含了数据存储结构、事件、集群、持久化等诸多信息，和数据存储结构相关的定义如下：</p>
<pre><div class="ace-chrome"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_type">struct</span> <span class="ace_identifier">redisServer</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">redisDb</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">db</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_storage ace_type">int</span> <span class="ace_identifier">dbnum</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// ... <span class="ace_cjk" style="width:NaNpx">等</span><span class="ace_cjk" style="width:NaNpx">等</span><span class="ace_cjk" style="width:NaNpx">等</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span><span class="ace_punctuation ace_operator">;</span>
</div></div></div></pre>
<p>由此可见 redis 服务是由 redis 数据库(redisDb)构成的。redisServer 中存储了 redisDb 数组，其初始化大小可配置：</p>
<pre><div class="ace-chrome"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># Set the number of databases. The default database is DB 0, you can select</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># a different one on a per-connection basis using SELECT &lt;dbid&gt; where</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_comment"># dbid is a number between 0 and 'databases'-1</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">databases</span> <span class="ace_constant ace_numeric">16</span>
</div></div></div></pre>
<p>默认值为 <code>16</code> :</p>
<pre><div class="ace-chrome"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> REDIS_DEFAULT_DBNUM     16</span>
</div></div></div></pre>
<p><code>server</code> 在初始化的时候会对每一个数据库做初始化操作，因此配置时用不着的数据库尽量关闭：</p>
<pre><div class="ace-chrome"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_punctuation ace_operator">...</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">server</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">dbnum</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">REDIS_DEFAULT_DBNUM</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_punctuation ace_operator">...</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_identifier">server</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">db</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">zmalloc</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">sizeof</span><span class="ace_paren ace_lparen">(</span><span class="ace_identifier">redisDb</span><span class="ace_paren ace_rparen">)</span><span class="ace_keyword ace_operator">*</span><span class="ace_identifier">server</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">dbnum</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_punctuation ace_operator">...</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword ace_control">for</span> <span class="ace_paren ace_lparen">(</span><span class="ace_identifier">j</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_constant ace_numeric">0</span><span class="ace_punctuation ace_operator">;</span> <span class="ace_identifier">j</span> <span class="ace_keyword ace_operator">&lt;</span> <span class="ace_identifier">server</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">dbnum</span><span class="ace_punctuation ace_operator">;</span> <span class="ace_identifier">j</span><span class="ace_keyword ace_operator">++</span><span class="ace_paren ace_rparen">)</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">server</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">db</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">j</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">dict</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">dictCreate</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">dbDictType</span><span class="ace_punctuation ace_operator">,</span><span class="ace_constant ace_language">NULL</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">server</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">db</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">j</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">expires</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">dictCreate</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">keyptrDictType</span><span class="ace_punctuation ace_operator">,</span><span class="ace_constant ace_language">NULL</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">server</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">db</span><span class="ace_paren ace_lparen">[</span><span class="ace_identifier">j</span><span class="ace_paren ace_rparen">]</span><span class="ace_punctuation ace_operator">.</span><span class="ace_identifier">blocking_keys</span> <span class="ace_keyword ace_operator">=</span> <span class="ace_identifier">dictCreate</span><span class="ace_paren ace_lparen">(</span><span class="ace_keyword ace_operator">&amp;</span><span class="ace_identifier">keylistDictType</span><span class="ace_punctuation ace_operator">,</span><span class="ace_constant ace_language">NULL</span><span class="ace_paren ace_rparen">)</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// ... <span class="ace_cjk" style="width:NaNpx">等</span><span class="ace_cjk" style="width:NaNpx">等</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span>
</div></div></div></pre>
<p>redisDb 的结构并不复杂：</p>
<pre><div class="ace-chrome"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_type">typedef</span> <span class="ace_storage ace_type">struct</span> <span class="ace_identifier">redisDb</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_identifier">dict</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">dict</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_storage ace_type">int</span> <span class="ace_identifier">id</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_storage ace_type">long</span> <span class="ace_storage ace_type">long</span> <span class="ace_identifier">avg_ttl</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// ... <span class="ace_cjk" style="width:NaNpx">等</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span> <span class="ace_identifier">redisDb</span><span class="ace_punctuation ace_operator">;</span>
</div></div></div></pre>
<p>其中 <code>dict *dict</code> 用来存储键值对数据。也就是说 <code>SET foo bar</code> 命令实际会将 foo 存入 <code>dict</code> 结构的 key 中。Redis 用来存储值的对象是 <code>redisObject</code> ，它是对 redis 不同数据类型的抽象：</p>
<pre><div class="ace-chrome"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_storage ace_type">typedef</span> <span class="ace_storage ace_type">struct</span> <span class="ace_identifier">redisObject</span> <span class="ace_paren ace_lparen">{</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_storage ace_type">unsigned</span> <span class="ace_identifier">type</span><span class="ace_punctuation ace_operator">:</span><span class="ace_constant ace_numeric">4</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_storage ace_type">unsigned</span> <span class="ace_identifier">encoding</span><span class="ace_punctuation ace_operator">:</span><span class="ace_constant ace_numeric">4</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_storage ace_type">void</span> <span class="ace_keyword ace_operator">*</span><span class="ace_identifier">ptr</span><span class="ace_punctuation ace_operator">;</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>    <span class="ace_comment">// ... <span class="ace_cjk" style="width:NaNpx">等</span></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_paren ace_rparen">}</span> <span class="ace_identifier">robj</span><span class="ace_punctuation ace_operator">;</span>
</div></div></div></pre>
<p>其中 <code>type</code> 代表一个 redis 数据类型(抽象给用户使用的)，<code>encoding</code> 代表 redis 内部对该类型的实际编码方式(底层的数据结构实现)， <code>*ptr</code> 是指向实际值的指针。</p>
<p><code>redisObject</code> 的类型为：</p>
<pre><div class="ace-chrome"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> REDIS_STRING 0  </span><span class="ace_comment">/* <span class="ace_cjk" style="width:NaNpx">字</span><span class="ace_cjk" style="width:NaNpx">符</span><span class="ace_cjk" style="width:NaNpx">串</span> */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> REDIS_LIST 1    </span><span class="ace_comment">/* <span class="ace_cjk" style="width:NaNpx">列</span><span class="ace_cjk" style="width:NaNpx">表</span> */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> REDIS_SET 2     </span><span class="ace_comment">/* <span class="ace_cjk" style="width:NaNpx">哈</span><span class="ace_cjk" style="width:NaNpx">希</span> */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> REDIS_ZSET 3    </span><span class="ace_comment">/* <span class="ace_cjk" style="width:NaNpx">集</span><span class="ace_cjk" style="width:NaNpx">合</span> */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> REDIS_HASH 4    </span><span class="ace_comment">/* <span class="ace_cjk" style="width:NaNpx">有</span><span class="ace_cjk" style="width:NaNpx">序</span><span class="ace_cjk" style="width:NaNpx">集</span><span class="ace_cjk" style="width:NaNpx">合</span> */</span>
</div></div></div></pre>
<p>编码方式有：</p>
<pre><div class="ace-chrome"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> REDIS_ENCODING_RAW 0        </span><span class="ace_comment">/* <span class="ace_cjk" style="width:NaNpx">原</span><span class="ace_cjk" style="width:NaNpx">始</span>sds<span class="ace_cjk" style="width:NaNpx">方</span><span class="ace_cjk" style="width:NaNpx">式</span> */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> REDIS_ENCODING_INT 1        </span><span class="ace_comment">/* <span class="ace_cjk" style="width:NaNpx">整</span><span class="ace_cjk" style="width:NaNpx">数</span> */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> REDIS_ENCODING_HT 2         </span><span class="ace_comment">/* <span class="ace_cjk" style="width:NaNpx">散</span><span class="ace_cjk" style="width:NaNpx">列</span><span class="ace_cjk" style="width:NaNpx">表</span> */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> REDIS_ENCODING_ZIPMAP 3     </span><span class="ace_comment">/* (<span class="ace_cjk" style="width:NaNpx">已</span><span class="ace_cjk" style="width:NaNpx">弃</span><span class="ace_cjk" style="width:NaNpx">用</span>) */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> REDIS_ENCODING_LINKEDLIST 4 </span><span class="ace_comment">/* <span class="ace_cjk" style="width:NaNpx">双</span><span class="ace_cjk" style="width:NaNpx">链</span><span class="ace_cjk" style="width:NaNpx">表</span> */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> REDIS_ENCODING_ZIPLIST 5    </span><span class="ace_comment">/* <span class="ace_cjk" style="width:NaNpx">压</span><span class="ace_cjk" style="width:NaNpx">缩</span><span class="ace_cjk" style="width:NaNpx">列</span><span class="ace_cjk" style="width:NaNpx">表</span> */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> REDIS_ENCODING_INTSET 6     </span><span class="ace_comment">/* <span class="ace_cjk" style="width:NaNpx">整</span><span class="ace_cjk" style="width:NaNpx">型</span><span class="ace_cjk" style="width:NaNpx">集</span><span class="ace_cjk" style="width:NaNpx">合</span> */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> REDIS_ENCODING_SKIPLIST 7   </span><span class="ace_comment">/* <span class="ace_cjk" style="width:NaNpx">跳</span><span class="ace_cjk" style="width:NaNpx">跃</span><span class="ace_cjk" style="width:NaNpx">表</span> */</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_keyword">#define</span><span class="ace_constant ace_other"> REDIS_ENCODING_EMBSTR 8     </span><span class="ace_comment">/* <span class="ace_cjk" style="width:NaNpx">内</span><span class="ace_cjk" style="width:NaNpx">嵌</span><span class="ace_cjk" style="width:NaNpx">式</span>sds */</span>
</div></div></div></pre>
<p>通常一个 redis 的对象类型都会对应两个以上的编码方式，它们的详细对应关系为：</p>
<p><img src="resources/17F186B3238570327E5D95AFE36E1BB1.jpg" alt="IMAGE" width="761" height="419"></p>
<p>命令示例：</p>
<pre><div class="ace-chrome"><div class="ace_static_highlight ace_show_gutter" style="counter-reset:ace_line 0"><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>$ <span class="ace_identifier">SET</span> <span class="ace_identifier">foo</span> <span class="ace_identifier">abc</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>$ <span class="ace_identifier">OBJECT</span> <span class="ace_identifier">ENCODING</span> <span class="ace_identifier">foo</span>  
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_string">"embstr"</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>$ <span class="ace_identifier">SET</span> <span class="ace_identifier">bar</span> <span class="ace_identifier">abcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyz</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>$ <span class="ace_identifier">OBJECT</span> <span class="ace_identifier">ENCODING</span> <span class="ace_identifier">bar</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_string">"raw"</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>$ <span class="ace_identifier">SET</span> <span class="ace_identifier">foobar</span> <span class="ace_constant ace_numeric">123</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>$ <span class="ace_identifier">OBJECT</span> <span class="ace_identifier">ENCODING</span> <span class="ace_identifier">foobar</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_string">"int"</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>$ <span class="ace_identifier">SET</span> <span class="ace_identifier">foobar</span> <span class="ace_constant ace_numeric">12345678901234567890</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>$ <span class="ace_identifier">OBJECT</span> <span class="ace_identifier">ENCODING</span> <span class="ace_identifier">foobar</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_string">"embstr"</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>$ <span class="ace_identifier">SET</span> <span class="ace_identifier">foobar</span> <span class="ace_constant ace_numeric">1.0</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span>$ <span class="ace_identifier">OBJECT</span> <span class="ace_identifier">ENCODING</span> <span class="ace_identifier">foobar</span>
</div><div class="ace_line"><span class="ace_gutter ace_gutter-cell" unselectable="on"></span><span class="ace_string">"embstr"</span>
</div></div></div></pre>
<p><em>(使用的源码基于 redis 3.0.5)</em></p>
<hr>
<p>@ssbunny 2015-12</p>
<p><img src="resources/9BDF5BC45B39A9BBFBF64D55FD48EC5B.png" alt="微信二维码_zhq_tiny.png" width="217" height="260"></p>
</div></div>
      <script>document.body.onkeyup = function(e) {
if (e.keyCode === 39) window.location.href = '[总结] 培训讲义_密码学基础.html';
if (e.keyCode === 37) window.location.href = '[笔记] Micro Frontends In Action.html';
}</script>
    </body>
    </html>
  